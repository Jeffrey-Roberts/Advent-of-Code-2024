package Day06;

import java.util.*;
import java.util.stream.Collectors;

public class Solution {
    public static class Guard {
        int row;
        int column;
        int rotation = 0;
        boolean exited = false;

        public Guard(int row, int column) {
            this.row = row;
            this.column = column;
        }

        public Guard(int row, int column, int rotation, boolean exited) {
            this.row = row;
            this.column = column;
            this.rotation = rotation;
            this.exited = exited;
        }

        public void rotate() {
            this.rotation = (this.rotation + 1) % 4;
        }

        public void move(List<List<String>> map) {
            switch (this.rotation) {
                case 0:
                    moveUp(map, this);
                    break;
                case 1:
                    moveRight(map, this);
                    break;
                case 2:
                    moveDown(map, this);
                    break;
                case 3:
                    moveLeft(map, this);
                    break;
            }
        }

        @Override
        public boolean equals(Object o) {
            if (this == o) return true;
            if (o == null || getClass() != o.getClass()) return false;
            Guard guard = (Guard) o;
            return this.rotation == guard.rotation && this.column == guard.column && this.row == guard.row && this.exited == guard.exited;
        }

        @Override
        public int hashCode() {
            return Objects.hash(this.row, this.column, this.rotation, this.exited);
        }

    }


    public static int predictGuardsMovement(String input) {
        List<List<String>> map = parseToMap(input);
        Guard guard = findGuard(map);
        assert guard != null;
        List<List<String>> traversedMap = guardMovement(map, guard);
        return traversedMap.stream().flatMap(List::stream).filter(elem -> elem.equals("X")).toList().size();
    }

    public static int validObstructions(String input) {
        List<List<String>> map = parseToMap(input);
        Guard initialGuard = findGuard(map);
        assert initialGuard != null;

        int startingRow = initialGuard.row;
        int startingColumn = initialGuard.column;
        List<List<String>> traversedMap = guardMovement(map, initialGuard);

        int totalObstructions = 0;
        for (int row = 0; row < traversedMap.size(); row++) {
            for (int column = 0; column < traversedMap.get(row).size(); column++) {
                String element = traversedMap.get(row).get(column);
                if (!element.equals("X") || (row == startingRow && column == startingColumn)) continue;
                List<List<String>> newMap = deepCopy(map);
                newMap.get(row).set(column, "#");

                Guard guard = new Guard(startingRow, startingColumn);
                Set<Guard> visitedLocation = new HashSet<>();
                while (!guard.exited) {
                    guard.move(newMap);
                    if (visitedLocation.contains(guard)) {
                        totalObstructions += 1;
                        break;
                    }
                    visitedLocation.add(new Guard(guard.row, guard.column, guard.rotation, guard.exited));
                }
            }
        }
        return totalObstructions;
    }

    private static List<List<String>> parseToMap(String input) {
        return Arrays.stream(input.split("\n"))
                .map(row -> Arrays.stream(row.split(""))
                        .collect(Collectors.toCollection(ArrayList::new)))
                .collect(Collectors.toCollection(ArrayList::new));
    }

    private static Guard findGuard(List<List<String>> map) {
        for (int row = 0; row < map.size(); row++) {
            for (int column = 0; column < map.get(row).size(); column++) {
                String elem = map.get(row).get(column);
                if (elem.equals("^")) return new Guard(row, column);
            }
        }
        return null;
    }

    private static List<List<String>> guardMovement(List<List<String>> map, Guard guard) {
        map.get(guard.row).set(guard.column, "X");

        while (!guard.exited) {
            guard.move(map);
            if (!map.get(guard.row).get(guard.column).equals("X")) {
                map.get(guard.row).set(guard.column, "X");
            }
        }

        return map;
    }

    private static void moveUp(List<List<String>> map, Guard guard) {
        int row = guard.row;
        int column = guard.column;

        if (row-1 < 0) guard.exited = true;
        else if (map.get(row-1).get(column).equals("#")) guard.rotate();
        else guard.row -= 1;
    }

    private static void moveDown(List<List<String>> map, Guard guard) {
        int row = guard.row;
        int column = guard.column;

        if (row+1 == map.size()) guard.exited = true;
        else if (map.get(row+1).get(column).equals("#")) guard.rotate();
        else guard.row += 1;
    }

    private static void moveLeft(List<List<String>> map, Guard guard) {
        int row = guard.row;
        int column = guard.column;

        if (column-1 < 0) guard.exited = true;
        else if (map.get(row).get(column-1).equals("#")) guard.rotate();
        else guard.column -= 1;
    }

    private static void moveRight(List<List<String>> map, Guard guard) {
        int row = guard.row;
        int column = guard.column;

        if (column+1 == map.get(row).size()) guard.exited = true;
        else if (map.get(row).get(column+1).equals("#")) guard.rotate();
        else guard.column += 1;
    }

    private static List<List<String>> deepCopy(List<List<String>> original) {
        List<List<String>> copy = new ArrayList<>();
        for (List<String> innerList : original) {
            List<String> newInnerList = new ArrayList<>(innerList);
            copy.add(newInnerList);
        }
        return copy;
    }

    public static void main() {
        String part1Input = """
                ....#.....#......#...............................#...........#.......#.....#................#...#....#....#................#..#.#.
                ...................................................................................#...........#............#.....................
                ..........#..............#.................................................#..............#.......................................
                ....................#...............#...#.....................#..............................#....#.............................#.
                ...............................##...............................................................#............#....................
                ................#...........#................#...............#....#.......#.............................#..........#...........#..
                ...........................#................................................#.##..................#.............#........#........
                ......#......#.....#..........#.......................#..........#.............#.....................#........#....#..............
                ..................................................#..................................#....#.........#...........#..............#..
                ..................................#..................#..........................................#.........#....................#..
                #.................#....................#...........#....................................#......................#..................
                .......#..........................................................................................................#...............
                ...............##.............................#...#.....................#..........................#.......................#......
                ...#.......................................................#..........................................#...................#..#....
                .......#...#.......#.#.............#.....#.##.........................#...........................................................
                #................#.........#.......................##............................................#...#.....#........#.......#.....
                #......##..............................................................#......#....#....#....#.#...............#............#..#..
                .....#...............................##.......................................#.......#......#............................#.....#.
                .........#......#...............................#.....#.....#...................##......#.........................................
                .#.................................................#...............#........#............................#........................
                #.........#.........................................#.......................#..............#......................#...........#...
                ..........................................##.............................................................##..#.......#............
                ...#.........................#...........................................#........#...............................................
                #..................#............#.................................................................#.#....................#....#..#
                ...................#.....................................#.#.........#.............#......#............................##.........
                ....#..............................................................##.......................................................#....#
                .....................#.....#.............................................#.......................#..................#.............
                ...........#.......................................#................#.........#...............#.#...........#.....#.....#........#
                .#..#.................#....#...............................#.................................................##...................
                ..#.....#......#..........#...................#..#..................................................#.......#...#.................
                .............................................................#.......................#..........#.....#...................#.......
                .......#.......................#.#....#...#.....##.......................#.................................................#......
                .................#.....................#...............................................................#..#.......................
                ...#.................#.#..................................................##......................................#..#............
                #........................................................#...#.........#................#.#.......................................
                .................#........#.#........................#.#..................................#.......................................
                ..........#..#......#..................#.........................#................................#...............................
                .............................................................................................#....................................
                .....................#...........#........##.....#.........................#..............................#.....#....#............
                ..#........#.........#.....................................................#......................................................
                ...................................#...................#............#.............#...........................#...................
                ....#.........................................................#................................#......#...#..#....................
                ................................................................................#..#.......#..........................#....#......
                #...........................................................................#........................#............................
                ..#..............#..........#...#..........................................................#......................................
                .......................................................#.................#.#....#.................#..........#....#...............
                ..................................................................................................................................
                .................#.........................................................#..........#.........#.........#.................#.....
                ....................#........#...................#................#...#....................#..............#................#......
                ...#.............##........................................#.........#.................#...........#.........#....................
                ................#............#...........#...............#.....................................#...........................#......
                ....................................................#...........#..............................#..........#...........#...........
                .........#..............#................................#.............#......................................#.........#...#.....
                ..#..#.........................................#.............................#....................................................
                .#............................##...#..........#............#..#.........................#......................#...#..............
                ........#.....#..............#..................................................#...#......................#....#..............#..
                ...............................................#.........#..................#............#.............................#..........
                ..................................................................................................#....#..........................
                ..............#..............................................................#....................................................
                .....#....#.....................#......................#...........#...#..#.............#.......................#.................
                .............................#...#..#...........................#............................................................#....
                .............................................#...............................#...................................................#
                ..................................................................#......#....#.......................#.......#........#..........
                ..................#.#.........................................................................................##.......#........#.
                .............................#.......................#.......................................##...................................
                .....#.............................................................................................................#.#............
                ...............##.........#..#.....#...............#....................#.................................#.#....#................
                ................#......................................................................#...............#...................#......
                .................#..............#.................................................................................................
                ............#...#...........................................................................................#......#..............
                ..#.....................................................................#.....#.#.#......#....#..........#........................
                .#........#.............................#.....................#.....................#....#........................................
                .......................................................................................................#..........................
                ...#........#..................................................#.........................................................#......#.
                .......#.......#..#.................................................................................................#.............
                ..............................#..#..........................#..#..................#.............#.................................
                ..................#...#.............................................#...................#.......#...............#.................
                ...#.......#........#.....................................#...........#.................................................#.........
                .#.............#....................................#........................................................##............#...#..
                ...............#.....#....................................................................................#....#................#.
                ....#...........................................................#.....#..............................................#............
                .........#..........#...........................#.......................................#....#....................#...............
                ...............................................................#..........#......^...............................................#
                #..........................#.....................#..............................#..............................#..................
                ...................#.....#......#...........#........#............#.......#.......#...............................................
                .....#.....#.............................................................#..............#........#..........................#....#
                ............#...............................................................#.............#......................#................
                .....#...............................................##........................................#.......#......#...................
                .........................................#........................................................................................
                ..........................#...............................#............#............................#.....#.......................
                ...##.........#......#.....#...............................................................#........#.............................
                ......#...............#.#......................#.......#..............................#...#.........#.........#..#.........#......
                ....#......#....#........#.#.............................#......................................................#.....#...........
                .....#.............#.....................#...#...............#....................................................................
                ......#............#............#.#............#....................#.............................................................
                .............#..................................................#....................#.............#.......#.............#........
                .............................................#......................................................................#.............
                ...............................#............................................................#................#...................#
                ............#.....#....................................................................................................#.#........
                .........................#....................#...##.......#............#..#.................................#......#.............
                ....#......................#.....................#...........#.........................................#......#.#.................
                ..................................................................#..........................#......................#.............
                .......................#......#..............................................................................#....................
                .......#.................#...............................##...............................................#.............#.........
                .#..............#.....................................................................................................#...........
                .......##.................#................#.#...#......................................#...............#...#.....................
                .............##......................................................#....................................#..........#............
                ....................................#............#............#............#.....................................#................
                ................#..#............................#..............................................#.....#...................#......#.
                ....................#....#......#..................#................#.............................................................
                ...............##...............#...#..........................#......#...............#..#................#.....#.............#...
                ...........#..........#..........#..#.........#....#...#......#..............#................#....#..#...........................
                #.....................#..#...................................#...#..............................#......#.#.#......................
                ............##...................#..#.............................................................................................
                ..............................................#.#.......................#.................#....#..................#.......#.......
                ....#................#......#........................................................#........#..............#....................
                .........#.#...............#............................###...........#...........................................................
                .........#.................................................................................#......#...#..............#......#.....
                ....#....#......#.#.........#..........#...............#.........#............##.............#..#............................#....
                ....#..#...#.....#...........................#.#.......................................#...#.....................#............#..#
                ...........#............................#........#...#......#...............................................#...#.................
                ..#...............................................................#..............................................#.........#......
                ...................#.....................................#....................................#.#.#............#............#.....
                .....#.................#...........................##.................#..#........................................................
                ...#.......#...................................#.............................#...........#......##.#...#.........#.#...........#..
                .#.............#......#..#...#......................................................#..............#.............#.#..............
                .......................#............#...................#.....................#.......................#.............#..#......#...
                ......................#..#.#.......#........#....#.............#.........#..............................#.#..........#........#...
                .................#.............#..#..........#...#.........#..................................#..#.............#................#.
                .#..................................#....#...........................................#..............................#...#.........
                """;
        System.out.println(predictGuardsMovement(part1Input));

        String part2Input = """
                ....#.....#......#...............................#...........#.......#.....#................#...#....#....#................#..#.#.
                ...................................................................................#...........#............#.....................
                ..........#..............#.................................................#..............#.......................................
                ....................#...............#...#.....................#..............................#....#.............................#.
                ...............................##...............................................................#............#....................
                ................#...........#................#...............#....#.......#.............................#..........#...........#..
                ...........................#................................................#.##..................#.............#........#........
                ......#......#.....#..........#.......................#..........#.............#.....................#........#....#..............
                ..................................................#..................................#....#.........#...........#..............#..
                ..................................#..................#..........................................#.........#....................#..
                #.................#....................#...........#....................................#......................#..................
                .......#..........................................................................................................#...............
                ...............##.............................#...#.....................#..........................#.......................#......
                ...#.......................................................#..........................................#...................#..#....
                .......#...#.......#.#.............#.....#.##.........................#...........................................................
                #................#.........#.......................##............................................#...#.....#........#.......#.....
                #......##..............................................................#......#....#....#....#.#...............#............#..#..
                .....#...............................##.......................................#.......#......#............................#.....#.
                .........#......#...............................#.....#.....#...................##......#.........................................
                .#.................................................#...............#........#............................#........................
                #.........#.........................................#.......................#..............#......................#...........#...
                ..........................................##.............................................................##..#.......#............
                ...#.........................#...........................................#........#...............................................
                #..................#............#.................................................................#.#....................#....#..#
                ...................#.....................................#.#.........#.............#......#............................##.........
                ....#..............................................................##.......................................................#....#
                .....................#.....#.............................................#.......................#..................#.............
                ...........#.......................................#................#.........#...............#.#...........#.....#.....#........#
                .#..#.................#....#...............................#.................................................##...................
                ..#.....#......#..........#...................#..#..................................................#.......#...#.................
                .............................................................#.......................#..........#.....#...................#.......
                .......#.......................#.#....#...#.....##.......................#.................................................#......
                .................#.....................#...............................................................#..#.......................
                ...#.................#.#..................................................##......................................#..#............
                #........................................................#...#.........#................#.#.......................................
                .................#........#.#........................#.#..................................#.......................................
                ..........#..#......#..................#.........................#................................#...............................
                .............................................................................................#....................................
                .....................#...........#........##.....#.........................#..............................#.....#....#............
                ..#........#.........#.....................................................#......................................................
                ...................................#...................#............#.............#...........................#...................
                ....#.........................................................#................................#......#...#..#....................
                ................................................................................#..#.......#..........................#....#......
                #...........................................................................#........................#............................
                ..#..............#..........#...#..........................................................#......................................
                .......................................................#.................#.#....#.................#..........#....#...............
                ..................................................................................................................................
                .................#.........................................................#..........#.........#.........#.................#.....
                ....................#........#...................#................#...#....................#..............#................#......
                ...#.............##........................................#.........#.................#...........#.........#....................
                ................#............#...........#...............#.....................................#...........................#......
                ....................................................#...........#..............................#..........#...........#...........
                .........#..............#................................#.............#......................................#.........#...#.....
                ..#..#.........................................#.............................#....................................................
                .#............................##...#..........#............#..#.........................#......................#...#..............
                ........#.....#..............#..................................................#...#......................#....#..............#..
                ...............................................#.........#..................#............#.............................#..........
                ..................................................................................................#....#..........................
                ..............#..............................................................#....................................................
                .....#....#.....................#......................#...........#...#..#.............#.......................#.................
                .............................#...#..#...........................#............................................................#....
                .............................................#...............................#...................................................#
                ..................................................................#......#....#.......................#.......#........#..........
                ..................#.#.........................................................................................##.......#........#.
                .............................#.......................#.......................................##...................................
                .....#.............................................................................................................#.#............
                ...............##.........#..#.....#...............#....................#.................................#.#....#................
                ................#......................................................................#...............#...................#......
                .................#..............#.................................................................................................
                ............#...#...........................................................................................#......#..............
                ..#.....................................................................#.....#.#.#......#....#..........#........................
                .#........#.............................#.....................#.....................#....#........................................
                .......................................................................................................#..........................
                ...#........#..................................................#.........................................................#......#.
                .......#.......#..#.................................................................................................#.............
                ..............................#..#..........................#..#..................#.............#.................................
                ..................#...#.............................................#...................#.......#...............#.................
                ...#.......#........#.....................................#...........#.................................................#.........
                .#.............#....................................#........................................................##............#...#..
                ...............#.....#....................................................................................#....#................#.
                ....#...........................................................#.....#..............................................#............
                .........#..........#...........................#.......................................#....#....................#...............
                ...............................................................#..........#......^...............................................#
                #..........................#.....................#..............................#..............................#..................
                ...................#.....#......#...........#........#............#.......#.......#...............................................
                .....#.....#.............................................................#..............#........#..........................#....#
                ............#...............................................................#.............#......................#................
                .....#...............................................##........................................#.......#......#...................
                .........................................#........................................................................................
                ..........................#...............................#............#............................#.....#.......................
                ...##.........#......#.....#...............................................................#........#.............................
                ......#...............#.#......................#.......#..............................#...#.........#.........#..#.........#......
                ....#......#....#........#.#.............................#......................................................#.....#...........
                .....#.............#.....................#...#...............#....................................................................
                ......#............#............#.#............#....................#.............................................................
                .............#..................................................#....................#.............#.......#.............#........
                .............................................#......................................................................#.............
                ...............................#............................................................#................#...................#
                ............#.....#....................................................................................................#.#........
                .........................#....................#...##.......#............#..#.................................#......#.............
                ....#......................#.....................#...........#.........................................#......#.#.................
                ..................................................................#..........................#......................#.............
                .......................#......#..............................................................................#....................
                .......#.................#...............................##...............................................#.............#.........
                .#..............#.....................................................................................................#...........
                .......##.................#................#.#...#......................................#...............#...#.....................
                .............##......................................................#....................................#..........#............
                ....................................#............#............#............#.....................................#................
                ................#..#............................#..............................................#.....#...................#......#.
                ....................#....#......#..................#................#.............................................................
                ...............##...............#...#..........................#......#...............#..#................#.....#.............#...
                ...........#..........#..........#..#.........#....#...#......#..............#................#....#..#...........................
                #.....................#..#...................................#...#..............................#......#.#.#......................
                ............##...................#..#.............................................................................................
                ..............................................#.#.......................#.................#....#..................#.......#.......
                ....#................#......#........................................................#........#..............#....................
                .........#.#...............#............................###...........#...........................................................
                .........#.................................................................................#......#...#..............#......#.....
                ....#....#......#.#.........#..........#...............#.........#............##.............#..#............................#....
                ....#..#...#.....#...........................#.#.......................................#...#.....................#............#..#
                ...........#............................#........#...#......#...............................................#...#.................
                ..#...............................................................#..............................................#.........#......
                ...................#.....................................#....................................#.#.#............#............#.....
                .....#.................#...........................##.................#..#........................................................
                ...#.......#...................................#.............................#...........#......##.#...#.........#.#...........#..
                .#.............#......#..#...#......................................................#..............#.............#.#..............
                .......................#............#...................#.....................#.......................#.............#..#......#...
                ......................#..#.#.......#........#....#.............#.........#..............................#.#..........#........#...
                .................#.............#..#..........#...#.........#..................................#..#.............#................#.
                .#..................................#....#...........................................#..............................#...#.........
                """;
        System.out.println(validObstructions(part2Input));
    }
}
